# Tox configuration for Agent OS
# Multi-version Python testing and quality checks
#
# Usage:
#   tox              - Run all environments
#   tox -e py311     - Run Python 3.11 tests only
#   tox -e lint      - Run linting only
#   tox -e coverage  - Run tests with coverage report
#
# Install tox: pip install tox

[tox]
envlist = py310, py311, py312, lint, typecheck
isolated_build = true
skip_missing_interpreters = true

[testenv]
description = Run tests with pytest
deps =
    pytest>=7.0
    pytest-asyncio>=0.21
    pytest-cov>=4.0
    pytest-timeout>=2.0
commands =
    pytest tests/ -v --tb=short {posargs}

[testenv:py310]
basepython = python3.10

[testenv:py311]
basepython = python3.11

[testenv:py312]
basepython = python3.12

[testenv:lint]
description = Run code quality checks
basepython = python3.11
deps =
    black>=23.0
    isort>=5.0
    flake8>=6.0
    flake8-bugbear
    flake8-comprehensions
skip_install = true
commands =
    black --check --line-length 100 src/ tests/
    isort --check-only --profile black --line-length 100 src/ tests/
    flake8 src/ tests/ --max-line-length 100 --extend-ignore E203,W503

[testenv:format]
description = Auto-format code
basepython = python3.11
deps =
    black>=23.0
    isort>=5.0
skip_install = true
commands =
    black --line-length 100 src/ tests/
    isort --profile black --line-length 100 src/ tests/

[testenv:typecheck]
description = Run type checking with mypy
basepython = python3.11
deps =
    mypy>=1.0
    types-PyYAML
    types-requests
commands =
    mypy src/ --ignore-missing-imports --no-error-summary
allowlist_externals = mypy

[testenv:coverage]
description = Run tests with coverage report
basepython = python3.11
deps =
    pytest>=7.0
    pytest-asyncio>=0.21
    pytest-cov>=4.0
commands =
    pytest tests/ \
        --cov=src \
        --cov-report=term-missing \
        --cov-report=html:htmlcov \
        --cov-report=xml:coverage.xml \
        --cov-fail-under=50 \
        -v {posargs}

[testenv:security]
description = Run security checks
basepython = python3.11
deps =
    bandit[toml]>=1.7
    safety>=2.0
skip_install = true
commands =
    bandit -r src/ -c pyproject.toml --severity-level medium
    safety check -r requirements.txt

[testenv:docs]
description = Build documentation
basepython = python3.11
deps =
    mkdocs>=1.5
    mkdocs-material>=9.0
skip_install = true
commands =
    mkdocs build --strict
allowlist_externals = mkdocs

[testenv:build]
description = Build distribution packages
basepython = python3.11
deps =
    build>=1.0
    twine>=4.0
skip_install = true
commands =
    python -m build
    twine check dist/*

# Pytest configuration
[pytest]
testpaths = tests
asyncio_mode = auto
addopts = -ra -q --strict-markers
markers =
    slow: marks tests as slow (deselect with '-m "not slow"')
    integration: marks tests as integration tests
    security: marks security-focused tests
filterwarnings =
    ignore::DeprecationWarning
    ignore::PendingDeprecationWarning

# Coverage configuration
[coverage:run]
source = src
branch = true
omit =
    */tests/*
    */__pycache__/*
    */migrations/*

[coverage:report]
exclude_lines =
    pragma: no cover
    def __repr__
    raise AssertionError
    raise NotImplementedError
    if __name__ == .__main__.:
    if TYPE_CHECKING:
    @abstractmethod
show_missing = true
precision = 2

[coverage:html]
directory = htmlcov

# Flake8 configuration
[flake8]
max-line-length = 100
extend-ignore = E203, W503
per-file-ignores =
    __init__.py:F401
    tests/*:S101
exclude =
    .git,
    __pycache__,
    build,
    dist,
    *.egg-info,
    venv,
    .venv,
    .tox

# isort configuration
[isort]
profile = black
line_length = 100
known_first_party = src
skip = venv,.venv,.tox,build,dist

# Black configuration (in pyproject.toml, but documented here)
# [tool.black]
# line-length = 100
# target-version = ['py310', 'py311', 'py312']
